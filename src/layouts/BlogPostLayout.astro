---
import BaseLayout from './BaseLayout.astro';
import CoupangBanner from '../components/CoupangBanner.astro';
import AdSlot from '../components/AdSlot.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import NewsletterCTA from '../components/NewsletterCTA.astro';
import CommentSection from '../components/CommentSection.astro';

interface ChartBarData {
  type: 'chart-bar';
  title?: string;
  unit?: string;
  data: { label: string; value: number }[];
  colors?: string[];
}

interface ChartRadarData {
  type: 'chart-radar';
  title?: string;
  categories: string[];
  datasets: { name: string; values: number[]; color?: string }[];
}

interface FaqItem {
  q: string;
  a: string;
}

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  author: string;
  category: string;
  tags: string[];
  image?: { url: string; alt: string };
  coupangLinks?: { title: string; url: string; imageUrl?: string }[];
  chartData?: (ChartBarData | ChartRadarData)[];
  slug?: string;
  faq?: FaqItem[];
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  category,
  tags,
  image,
  coupangLinks,
  chartData,
  slug,
  faq,
} = Astro.props;

const formattedDate = new Date(pubDate).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Reading time estimate (Korean: ~500 chars/min)
const categoryLabel: Record<string, string> = {
  ai: 'AI & 인공지능',
  dev: '개발 & 프로그래밍',
  review: '제품 리뷰',
};
const catLabel = categoryLabel[category.toLowerCase()] || category;

// JSON-LD structured data for SEO
const canonicalUrl = Astro.url.href;
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: description,
  datePublished: pubDate.toISOString(),
  ...(updatedDate && { dateModified: updatedDate.toISOString() }),
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'TechFlow Blog',
    url: 'https://ai-revenue-blog.vercel.app',
    logo: {
      '@type': 'ImageObject',
      url: 'https://ai-revenue-blog.vercel.app/favicon.svg',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
  keywords: tags.join(', '),
  ...(image && {
    image: {
      '@type': 'ImageObject',
      url: image.url,
      alt: image.alt,
    },
  }),
};

// BreadcrumbList schema for navigation hierarchy
const breadcrumbLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: '홈',
      item: 'https://ai-revenue-blog.vercel.app/',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: '블로그',
      item: 'https://ai-revenue-blog.vercel.app/blog/',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: catLabel,
      item: `https://ai-revenue-blog.vercel.app/blog/${category.toLowerCase()}/`,
    },
    {
      '@type': 'ListItem',
      position: 4,
      name: title,
    },
  ],
};

// FAQPage JSON-LD (구글 FAQ 리치 스니펫)
const faqLd = faq && faq.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faq.map(item => ({
    '@type': 'Question',
    name: item.q,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.a,
    },
  })),
} : null;

// Get previous/next posts for navigation
import { getCollection } from 'astro:content';
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
const currentIndex = allPosts.findIndex(post => post.id === slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

// Same-category series navigation
const seriesPosts = allPosts
  .filter(p => p.data.category?.toLowerCase() === category.toLowerCase())
  .sort((a, b) => new Date(a.data.pubDate).getTime() - new Date(b.data.pubDate).getTime());
const seriesIndex = seriesPosts.findIndex(p => p.id === slug);
const seriesTotal = seriesPosts.length;
---

<BaseLayout title={title} description={description} image={image?.url}>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbLd)} />
  {faqLd && <script type="application/ld+json" set:html={JSON.stringify(faqLd)} />}

  <article class="blog-post">
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb" aria-label="breadcrumb">
      <ol>
        <li><a href="/">홈</a></li>
        <li><a href="/blog/">블로그</a></li>
        <li><a href={`/blog/${category.toLowerCase()}/`}>{catLabel}</a></li>
        <li aria-current="page">{title}</li>
      </ol>
    </nav>

    <header class="post-header">
      <div class="post-meta">
        <span class="post-category" data-cat={category.toLowerCase()}>{category}</span>
        <time datetime={pubDate.toISOString()}>{formattedDate}</time>
        <span class="post-reading-time">읽기 약 3분</span>
        {
          updatedDate && (
            <span class="post-updated">
              (수정:{' '}
              {new Date(updatedDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
              )
            </span>
          )
        }
      </div>
      <div class="post-title-row">
        <h1>{title}</h1>
        <button class="bookmark-btn" id="bookmark-btn" data-slug={slug} aria-label="북마크" title="이 글 북마크하기">
          <svg class="bookmark-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
      </div>
      <p class="post-description">{description}</p>
      <div class="post-tags">
        {tags.map((tag) => (
          <a href={`/blog/tags/${encodeURIComponent(tag)}/`} class="tag">#{tag}</a>
        ))}
      </div>

      <!-- Social Share Buttons -->
      <div class="share-buttons">
        <span class="share-label">공유하기</span>
        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(canonicalUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn share-twitter"
          aria-label="트위터에 공유"
          title="트위터에 공유"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </a>
        <a
          href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(canonicalUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn share-facebook"
          aria-label="페이스북에 공유"
          title="페이스북에 공유"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </a>
        <a
          href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(canonicalUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn share-linkedin"
          aria-label="링크드인에 공유"
          title="링크드인에 공유"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </a>
        <button
          type="button"
          class="share-btn share-copy"
          id="copy-link-btn"
          aria-label="링크 복사"
          title="링크 복사"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
          </svg>
        </button>
        <div class="copy-tooltip" id="copy-tooltip">링크가 복사되었습니다!</div>
      </div>
    </header>

    {image && <img src={image.url} alt={image.alt} class="post-hero-image" />}

    <!-- 목차 (ToC) - JS로 자동 생성 -->
    <nav class="toc" id="toc"></nav>

    <!-- 상단 광고 슬롯 -->
    <AdSlot position="top" />

    <div class="post-content" id="post-content">
      <slot />
    </div>

    <!-- 쿠팡 추천 상품 -->
    {coupangLinks && coupangLinks.length > 0 && (
      <CoupangBanner links={coupangLinks} />
    )}

    <!-- 관련 글 추천 -->
    {slug && (
      <RelatedPosts currentSlug={slug} category={category} tags={tags} />
    )}

    <!-- Newsletter CTA -->
    <NewsletterCTA />

    <!-- 댓글 섹션 -->
    {slug && <CommentSection slug={slug} source="blog" />}

    <!-- 이전/다음 글 네비게이션 -->
    {(prevPost || nextPost) && (
      <nav class="post-navigation" aria-label="Post navigation">
        <div class="post-nav-grid">
          {prevPost ? (
            <a href={`/blog/${prevPost.id}/`} class="post-nav-link post-nav-prev">
              <span class="post-nav-label">← 이전 글</span>
              <span class="post-nav-title">{prevPost.data.title}</span>
            </a>
          ) : (
            <div></div>
          )}
          {nextPost ? (
            <a href={`/blog/${nextPost.id}/`} class="post-nav-link post-nav-next">
              <span class="post-nav-label">다음 글 →</span>
              <span class="post-nav-title">{nextPost.data.title}</span>
            </a>
          ) : (
            <div></div>
          )}
        </div>
      </nav>
    )}

    <!-- 시리즈 네비게이션 -->
    {seriesTotal > 1 && (
      <div class="series-box">
        <div class="series-header">
          <span class="series-icon">&#128218;</span>
          <div>
            <span class="series-label">{catLabel} 시리즈</span>
            <span class="series-progress">{seriesIndex + 1} / {seriesTotal}</span>
          </div>
        </div>
        <div class="series-progress-bar">
          <div class="series-progress-fill" style={`width: ${((seriesIndex + 1) / seriesTotal) * 100}%`}></div>
        </div>
        <ul class="series-list">
          {seriesPosts.map((p, i) => (
            <li class={`series-item ${i === seriesIndex ? 'series-current' : ''}`}>
              <span class="series-num">{i + 1}</span>
              {i === seriesIndex ? (
                <span class="series-title-current">{p.data.title}</span>
              ) : (
                <a href={`/blog/${p.id}/`} class="series-title-link">{p.data.title}</a>
              )}
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- 인기글 위젯 -->
    <div class="popular-posts-widget" id="popular-posts-widget">
      <h4 class="popular-posts-title">&#128293; 인기 글 TOP 5</h4>
      <div class="popular-posts-list" id="popular-posts-list">
        <div class="popular-posts-loading">로딩 중...</div>
      </div>
    </div>

    <!-- 추천 버튼 -->
    <div class="like-section">
      <button class="like-btn" id="like-btn" aria-label="추천">
        <span class="like-icon" id="like-icon">&#9825;</span>
        <span class="like-count" id="like-count">0</span>
      </button>
      <span class="like-label">이 글이 도움이 되었나요?</span>
    </div>

    <!-- 관련 글 안내 -->
    <div class="post-cta">
      <h3>더 많은 글을 둘러보세요</h3>
      <p>더 많은 유용한 콘텐츠를 확인해보세요.</p>
      <div class="post-cta-buttons">
        <a href="/blog/" class="btn-primary">전체 글 보기</a>
        <a href={`/blog/${category.toLowerCase()}/`} class="btn-secondary">{catLabel} 더 보기</a>
      </div>
    </div>

    <!-- 하단 광고 슬롯 -->
    <AdSlot position="bottom" />

    <!-- AI 작성 안내 -->
    <aside class="ai-disclaimer">
      <p>이 글은 AI 기술을 활용하여 작성되었습니다. 핵심 정보와 데이터는 검증을 거쳤으나, 정확한 의사결정을 위해 공식 출처를 통한 추가 확인을 권장합니다.</p>
    </aside>

    <!-- 익명 댓글 시스템 -->
    <section class="comments-section" id="comments-section" data-slug={slug} data-blog="techflow">
      <h3>댓글 <span class="comment-count" id="comment-count"></span></h3>

      <!-- 댓글 작성 폼 -->
      <form class="comment-form" id="comment-form">
        <div class="comment-form-row">
          <input type="text" id="comment-name" placeholder="이름 (선택, 미입력 시 '익명')" maxlength="20" class="comment-input" />
          <input type="password" id="comment-password" placeholder="삭제용 비밀번호 (필수)" maxlength="30" required class="comment-input" />
        </div>
        <textarea id="comment-content" placeholder="댓글을 입력하세요..." rows="3" maxlength="1000" required class="comment-textarea"></textarea>
        <div class="comment-form-footer">
          <span class="comment-char-count" id="comment-char-count">0 / 1000</span>
          <button type="submit" class="comment-submit-btn" id="comment-submit-btn">댓글 등록</button>
        </div>
      </form>

      <!-- 댓글 목록 -->
      <div class="comment-list" id="comment-list">
        <p class="comment-loading" id="comment-loading">댓글을 불러오는 중...</p>
      </div>

      <!-- 삭제 모달 -->
      <div class="comment-modal-overlay" id="delete-modal" style="display:none;">
        <div class="comment-modal">
          <h4>댓글 삭제</h4>
          <p>작성 시 입력한 비밀번호를 입력하세요.</p>
          <input type="password" id="delete-password" placeholder="비밀번호" class="comment-input" />
          <div class="comment-modal-btns">
            <button type="button" class="comment-cancel-btn" id="delete-cancel">취소</button>
            <button type="button" class="comment-delete-btn" id="delete-confirm">삭제</button>
          </div>
          <p class="comment-error" id="delete-error" style="display:none;"></p>
        </div>
      </div>
    </section>
  </article>

  <script is:inline src="/js/blog-post.js"></script>
</BaseLayout>
