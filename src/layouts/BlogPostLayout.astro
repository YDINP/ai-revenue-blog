---
import BaseLayout from './BaseLayout.astro';
import CoupangBanner from '../components/CoupangBanner.astro';
import AdSlot from '../components/AdSlot.astro';
import RelatedPosts from '../components/RelatedPosts.astro';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  author: string;
  category: string;
  tags: string[];
  image?: { url: string; alt: string };
  coupangLinks?: { title: string; url: string; imageUrl?: string }[];
  slug?: string;
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  category,
  tags,
  image,
  coupangLinks,
  slug,
} = Astro.props;

const formattedDate = new Date(pubDate).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Reading time estimate (Korean: ~500 chars/min)
const categoryLabel: Record<string, string> = {
  ai: 'AI & 인공지능',
  dev: '개발 & 프로그래밍',
  review: '제품 리뷰',
};
const catLabel = categoryLabel[category.toLowerCase()] || category;

// JSON-LD structured data for SEO
const canonicalUrl = Astro.url.href;
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description: description,
  datePublished: pubDate.toISOString(),
  ...(updatedDate && { dateModified: updatedDate.toISOString() }),
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'TechFlow Blog',
    url: 'https://ai-revenue-blog.vercel.app',
    logo: {
      '@type': 'ImageObject',
      url: 'https://ai-revenue-blog.vercel.app/favicon.svg',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
  keywords: tags.join(', '),
  ...(image && {
    image: {
      '@type': 'ImageObject',
      url: image.url,
      alt: image.alt,
    },
  }),
};
---

<BaseLayout title={title} description={description} image={image?.url}>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  
  <article class="blog-post">
    <!-- 뒤로가기 -->
    <a href={`/blog/${category.toLowerCase()}/`} class="post-back">&larr; {catLabel} 목록</a>

    <header class="post-header">
      <div class="post-meta">
        <span class="post-category" data-cat={category.toLowerCase()}>{category}</span>
        <time datetime={pubDate.toISOString()}>{formattedDate}</time>
        <span class="post-reading-time">읽기 약 3분</span>
        {
          updatedDate && (
            <span class="post-updated">
              (수정:{' '}
              {new Date(updatedDate).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
              )
            </span>
          )
        }
      </div>
      <h1>{title}</h1>
      <p class="post-description">{description}</p>
      <div class="post-tags">
        {tags.map((tag) => <span class="tag">#{tag}</span>)}
      </div>
    </header>

    {image && <img src={image.url} alt={image.alt} class="post-hero-image" />}

    <!-- 목차 (ToC) - JS로 자동 생성 -->
    <nav class="toc" id="toc"></nav>

    <!-- 상단 광고 슬롯 -->
    <AdSlot position="top" />

    <div class="post-content" id="post-content">
      <slot />
    </div>

    <!-- 쿠팡 추천 상품 -->
    {coupangLinks && coupangLinks.length > 0 && (
      <CoupangBanner links={coupangLinks} />
    )}

    <!-- 관련 글 추천 -->
    {slug && (
      <RelatedPosts currentSlug={slug} category={category} tags={tags} />
    )}

    <!-- 관련 글 안내 -->
    <div class="post-cta">
      <h3>이 글이 도움이 되셨나요?</h3>
      <p>더 많은 유용한 콘텐츠를 확인해보세요.</p>
      <div class="post-cta-buttons">
        <a href="/blog/" class="btn-primary">전체 글 보기</a>
        <a href={`/blog/${category.toLowerCase()}/`} class="btn-secondary">{catLabel} 더 보기</a>
      </div>
    </div>

    <!-- 하단 광고 슬롯 -->
    <AdSlot position="bottom" />
  </article>

  <script>
    // Auto-generate Table of Contents
    (function() {
      const content = document.getElementById('post-content');
      const toc = document.getElementById('toc');
      if (!content || !toc) return;

      const headings = content.querySelectorAll('h2, h3');
      if (headings.length < 2) { toc.style.display = 'none'; return; }

      let html = '<h4>목차</h4><ul>';
      headings.forEach((h, i) => {
        const id = 'heading-' + i;
        h.id = id;
        const indent = h.tagName === 'H3' ? ' class="toc-sub"' : '';
        html += `<li${indent}><a href="#${id}">${h.textContent}</a></li>`;
      });
      html += '</ul>';
      toc.innerHTML = html;

      // Estimate reading time
      const text = content.textContent || '';
      const minutes = Math.max(1, Math.round(text.length / 500));
      const readingEl = document.querySelector('.post-reading-time');
      if (readingEl) readingEl.textContent = `읽기 약 ${minutes}분`;

      // === Chart Rendering System (Enhanced) ===
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b},${alpha})`;
      }

      // IntersectionObserver for scroll animation
      const chartObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.querySelectorAll('.chart-fill, .radar-score-fill').forEach(fill => {
              fill.classList.add('animated');
            });
            chartObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.2 });

      // 1) Render bar charts
      document.querySelectorAll('.chart-bar').forEach(el => {
        const labels = (el.dataset.labels || '').split(',');
        const values = (el.dataset.values || '').split(',').map(Number);
        const colors = (el.dataset.colors || '#3b82f6,#f59e0b,#10b981,#ef4444,#8b5cf6').split(',');
        const title = el.dataset.title || '';
        const unit = el.dataset.unit || '';
        const max = Math.max(...values) * 1.15;

        let html = '';
        if (title) html += `<div class="chart-title">${title}</div>`;
        html += '<div class="chart-bars">';
        labels.forEach((label, i) => {
          const pct = max > 0 ? (values[i] / max) * 100 : 0;
          const color = colors[i % colors.length].trim();
          const grad = `linear-gradient(90deg, ${color}, ${hexToRgba(color, 0.7)})`;
          html += `<div class="chart-row">
            <span class="chart-label">${label.trim()}</span>
            <div class="chart-track">
              <div class="chart-fill" style="width:${pct}%;background:${grad}">
                ${pct > 25 ? `<span class="chart-fill-inner-val">${values[i]}${unit}</span>` : ''}
              </div>
            </div>
            <span class="chart-value">${values[i]}${unit}</span>
          </div>`;
        });
        html += '</div>';
        el.innerHTML = html;
        chartObserver.observe(el);
      });

      // 2) Render radar/score charts
      document.querySelectorAll('.chart-radar').forEach(el => {
        const items = JSON.parse(el.dataset.items || '[]');
        const title = el.dataset.title || '';
        let html = '';
        if (title) html += `<div class="chart-title">${title}</div>`;
        html += '<div class="chart-radar-grid">';
        items.forEach(item => {
          const scores = item.scores || [];
          const avg = scores.length > 0 ? (scores.reduce((a,s) => a + s.value, 0) / scores.length).toFixed(1) : '0';
          const mainColor = scores[0]?.color || '#3b82f6';
          html += `<div class="radar-item">
            <div class="radar-item-accent" style="background:${mainColor}"></div>
            <div class="radar-name" style="color:${mainColor}">${item.name}</div>
            <div class="radar-avg">
              <span class="radar-avg-badge" style="background:${hexToRgba(mainColor, 0.12)};color:${mainColor}">
                평균 ${avg}/10
              </span>
            </div>
            <div class="radar-scores">`;
          scores.forEach(s => {
            const pct = (s.value / 10) * 100;
            const grad = `linear-gradient(90deg, ${s.color || '#3b82f6'}, ${hexToRgba(s.color || '#3b82f6', 0.6)})`;
            html += `<div class="radar-score-row">
              <span class="radar-score-label">${s.label}</span>
              <div class="radar-score-track">
                <div class="radar-score-fill" style="width:${pct}%;background:${grad}"></div>
              </div>
              <span class="radar-score-val" style="color:${s.color || '#3b82f6'}">${s.value}</span>
            </div>`;
          });
          html += '</div></div>';
        });
        html += '</div>';
        el.innerHTML = html;
        chartObserver.observe(el);
      });
    })();
  </script>
</BaseLayout>
