---
import '../styles/global.css';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description: string;
  image?: string;
  canonicalUrl?: string;
}

const { title, description, image, canonicalUrl } = Astro.props;
const siteTitle = 'TechFlow - AI & í…Œí¬ ì¸ì‚¬ì´íŠ¸';
const fullTitle = title === siteTitle ? title : `${title} | ${siteTitle}`;
const defaultOgImage = 'https://images.pexels.com/photos/18068768/pexels-photo-18068768.png?auto=compress&cs=tinysrgb&w=1200&h=630&dpr=1';
const ogImage = image || defaultOgImage;
const canonical = canonicalUrl || Astro.url.href;
const currentPath = Astro.url.pathname;

// ë™ì  ì¹´í…Œê³ ë¦¬ ìƒì„±
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const categoryMap: Record<string, { label: string; count: number }> = {};
allPosts.forEach(post => {
  const cat = post.data.category;
  const key = cat.toLowerCase();
  if (!categoryMap[key]) {
    categoryMap[key] = { label: cat, count: 0 };
  }
  categoryMap[key].count++;
});
const categories = Object.entries(categoryMap)
  .sort((a, b) => b[1].count - a[1].count)
  .map(([key, val]) => ({ slug: key, label: val.label, count: val.count }));

// WebSite JSON-LD schema with SearchAction
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'TechFlow',
  alternateName: 'TechFlow Blog',
  url: 'https://ai-revenue-blog.vercel.app',
  description: 'AI, ê°œë°œ, ê¸°ìˆ  ë¦¬ë·° ì „ë¬¸ ë¸”ë¡œê·¸ - ìµœì‹  ê¸°ìˆ  íŠ¸ë Œë“œì™€ ì‹¤ìš©ì ì¸ ê°œë°œ ê°€ì´ë“œ',
  inLanguage: 'ko-KR',
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: 'https://ai-revenue-blog.vercel.app/blog/?q={search_term_string}',
    },
    'query-input': 'required name=search_term_string',
  },
};
---

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <meta name="author" content="TechFlow" />
    <meta name="robots" content="index, follow" />
    <meta name="google-site-verification" content="uShjQZTfZFAauTdbCg7ZN0cvDV_ErVoVmdCScJ75TIQ" />
    <meta name="naver-site-verification" content="8690f68a97ed2c84b4644bbe00fa2ec9ccdbe55e" />
    <meta name="theme-color" content="#2563eb" />
    <link rel="canonical" href={canonical} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={canonical} />
    <meta property="og:locale" content="ko_KR" />
    <meta property="og:site_name" content={siteTitle} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="alternate" type="application/rss+xml" title={siteTitle} href="/rss.xml" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- WebSite Schema -->
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    <!-- Pretendard Font -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet" />

    <!-- Google AdSense (ìŠ¹ì¸ í›„ í™œì„±í™”)
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9400779918671270" crossorigin="anonymous"></script>
    -->

    <!-- Dark Mode Init (FOUC ë°©ì§€) -->
    <script is:inline>
      (function() {
        const t = localStorage.getItem('theme');
        if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>

  <body>
    <!-- Reading Progress -->
    <div class="reading-progress" id="reading-progress"></div>

    <header class="site-header">
      <nav class="nav-container">
        <a href="/" class="site-logo">TechFlow</a>
        <div class="nav-right">
          <div class="nav-links" id="nav-menu">
            <a href="/blog/" class={currentPath === '/blog/' ? 'active' : ''}>Blog</a>
            {categories.map(cat => (
              <a href={`/blog/${cat.slug}/`} class={currentPath.includes(`/blog/${cat.slug}`) ? 'active' : ''}>{cat.label}</a>
            ))}
            <a href="/blog/tags/" class={currentPath.includes('/blog/tags') ? 'active' : ''}>íƒœê·¸</a>
          </div>
          <button class="theme-toggle" id="theme-toggle" aria-label="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
            <span id="theme-icon">ğŸŒ™</span>
          </button>
          <button class="nav-toggle" id="nav-toggle" aria-label="ë©”ë‰´ ì—´ê¸°">â˜°</button>
        </div>
      </nav>
    </header>

    <main>
      <slot />
    </main>

    <footer class="site-footer">
      <div class="footer-container">
        <div class="footer-grid">
          <div class="footer-section">
            <h4>ì¹´í…Œê³ ë¦¬</h4>
            <ul>
              {categories.map(cat => (
                <li><a href={`/blog/${cat.slug}/`}>{cat.label} ({cat.count})</a></li>
              ))}
            </ul>
          </div>
          <div class="footer-section">
            <h4>ë°”ë¡œê°€ê¸°</h4>
            <ul>
              <li><a href="/blog/">ì „ì²´ ê¸€</a></li>
              <li><a href="/rss.xml">RSS í”¼ë“œ</a></li>
              <li><a href="/dashboard/">ëŒ€ì‹œë³´ë“œ</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>TechFlow</h4>
            <ul>
              <li><a href="/">í™ˆ</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="/contact/">Contact</a></li>
              <li><a href="/privacy/">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a></li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; {new Date().getFullYear()} TechFlow. All rights reserved.</p>
          <p class="footer-note">
            ì´ ì‚¬ì´íŠ¸ì˜ ì¼ë¶€ ë§í¬ëŠ” ì œíœ´ ë§ˆì¼€íŒ… ë§í¬ì´ë©°, êµ¬ë§¤ ì‹œ ì†Œì •ì˜ ìˆ˜ìˆ˜ë£Œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </footer>

    <!-- Back to Top -->
    <button class="back-to-top" id="back-to-top" aria-label="ë§¨ ìœ„ë¡œ">â†‘</button>

    <script>
      // Pageview tracking
      (function() {
        const ANALYTICS_URL = 'https://mkatzcmsrdntsmnykxpt.supabase.co/functions/v1/analytics-ingest';
        const slug = window.location.pathname.replace(/^\/blog\//, '').replace(/\/$/, '');
        fetch(ANALYTICS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event_type: 'pageview',
            source: 'blog',
            metadata: { slug, path: window.location.pathname, referrer: document.referrer || 'direct', user_agent: navigator.userAgent }
          })
        }).catch(() => {});
      })();

      // Reading progress
      function updateProgress() {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const pct = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
        const bar = document.getElementById('reading-progress');
        if (bar) bar.style.width = pct + '%';
      }
      window.addEventListener('scroll', updateProgress);

      // Back to top
      const btt = document.getElementById('back-to-top');
      window.addEventListener('scroll', () => {
        if (btt) btt.classList.toggle('show', window.scrollY > 400);
      });
      btt?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

      // Dark mode toggle
      const toggle = document.getElementById('theme-toggle');
      const icon = document.getElementById('theme-icon');
      function syncIcon() {
        if (icon) icon.textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
      }
      syncIcon();
      toggle?.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        syncIcon();
      });

      // Mobile nav toggle
      const navToggle = document.getElementById('nav-toggle');
      const navMenu = document.getElementById('nav-menu');
      navToggle?.addEventListener('click', () => navMenu?.classList.toggle('open'));

      // Service Worker Registration (PWA)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
    </script>
  </body>
</html>
